name: Android CI
on:
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:

jobs:
  build-release:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          target: default
          arch: x64
      
      - name: Accept Android SDK licenses and install NDK
        run: |
          SDKMANAGER_CMD=""
          if [ -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
            SDKMANAGER_CMD="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          elif [ -d "$ANDROID_HOME/tools/bin" ]; then
            SDKMANAGER_CMD="$ANDROID_HOME/tools/bin/sdkmanager"
          elif command -v sdkmanager &> /dev/null; then
            SDKMANAGER_CMD="sdkmanager"
          fi
          
          if [ -n "$SDKMANAGER_CMD" ]; then
            yes | $SDKMANAGER_CMD --licenses || true
            $SDKMANAGER_CMD "platform-tools" "platforms;android-35" "build-tools;35.0.0"
            # Try to install NDK - if specific version fails, try latest
            $SDKMANAGER_CMD "ndk;27.2.12479018" || $SDKMANAGER_CMD "ndk;27.1.10909125" || $SDKMANAGER_CMD "ndk-bundle" || echo "NDK installation attempted"
          else
            echo "sdkmanager not found, NDK may need to be installed manually"
          fi
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: Decode and create xed.keystore
        run: echo "${{ secrets.KEYSTORE }}" | base64 -d > /tmp/xed.keystore

      - name: Decode and create signing.properties
        run: echo "${{ secrets.PROP }}" | base64 -d > /tmp/signing.properties

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Set Commit Hash
        id: commit_hash
        run: echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Clean build
        run: ./gradlew clean --quiet

      - name: Build with Gradle
        run: ./gradlew assembleFdroidRelease --quiet || (./gradlew clean --quiet && ./gradlew assembleFdroidRelease --stacktrace)
        env:
          KEYSTORE_FILE: /tmp/xed.keystore
          SIGNING_PROPERTIES_FILE: /tmp/signing.properties
        continue-on-error: false

      - name: Move APK
        run: mv app/build/outputs/apk/Fdroid/release/*.apk app/reterminal-${{ env.COMMIT_HASH }}.apk

      - name: Archive APK
        uses: actions/upload-artifact@v4
        with:
          name: Karbon-Release
          path: app/reterminal-${{ env.COMMIT_HASH }}.apk

      - name: Delete xed.keystore and signing.properties
        run: rm /tmp/xed.keystore /tmp/signing.properties

      - name: Send APK to Telegram
        if: ${{ success() && github.event.head_commit.message != '' }}
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT }}/sendDocument" \
          -F chat_id="-1002292589492" \
          -F message_thread_id="116" \
          -F caption="${{ github.event.head_commit.message }} by ${{ github.actor }}" \
          -F document=@"app/reterminal-${{ env.COMMIT_HASH }}.apk"
